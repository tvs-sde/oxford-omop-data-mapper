<Query>
    <Sql>
with BR as (
    select
        Record ->> '$.PrimaryPathway.LinkageDiagnosticDetails.DateOfPrimaryDiagnosisClinicallyAgreed' as DateOfPrimaryDiagnosisClinicallyAgreed,
        coalesce(
            Record ->> '$.Treatment[0].TreatmentStartDateCancer', 
            Record ->> '$.Treatment.TreatmentStartDateCancer'
        ) as TreatmentStartDateCancer,
        coalesce(
            Record ->> '$.Treatment[0].Surgery.ProcedureDate', 
            Record ->> '$.Treatment.Surgery.ProcedureDate'
        ) as ProcedureDate,
        Record ->> '$.ClinicalNurseSpecialistAndRiskFactorAssessments.MenopausalStatus.@code' as MenopausalStatus,
        Record ->> '$.LinkagePatientId.NhsNumber.@extension' as NhsNumber
    from omop_staging.cosd_staging_901
    where type = 'BR'
)
select
    distinct
        MenopausalStatus,
        NhsNumber,
        least(
            cast(DateOfPrimaryDiagnosisClinicallyAgreed as date),
            cast(TreatmentStartDateCancer as date),
            cast(ProcedureDate as date)
        ) as Date
from BR o
where o.MenopausalStatus is not null
  and not (
        DateOfPrimaryDiagnosisClinicallyAgreed is null and
        TreatmentStartDateCancer is null and
        ProcedureDate is null
    );
    </Sql>
    <Explanations>
      <Explanation columnName="NHSNumber">
    	  <Description>Patient NHS Number</Description>
    	  <Origin>NHS NUMBER</Origin>
      </Explanation>
		 <Explanation columnName="MenopausalStatus">
		   <Description>MenopausalStatus</Description>
		   <Origin>MenopausalStatus</Origin>
		</Explanation>
      <Explanation columnName="Date" >
    	  <Description>Observation date</Description>
    	  <Origin>DATE OF PRIMARY CANCER DIAGNOSIS (CLINICALLY AGREED)</Origin>
    	  <Origin>TREATMENT START DATE (CANCER)</Origin>
    	  <Origin>PROCEDURE DATE</Origin>
      </Explanation>
    </Explanations>
</Query>